# This custom script runs desync of some udp packets to Discord subnets
# using ports specified in `$NFQWS_PORTS_UDP_DISCORD` (defined in the zapret-config.sh).
# Initializes `$SET_NAME` with `$SUBNETS`.

# This script will not execute if the var is unset or commented out in the config.
[ -z "$NFQWS_PORTS_UDP_DISCORD" ] && return

DISCORD_SUBNETS_RUSSIA="66.22.216.9 66.22.216.10/31 66.22.216.12/30 66.22.216.17 66.22.216.18 66.22.216.20/30 66.22.216.24/29 66.22.216.32 66.22.216.34 66.22.216.36/30 66.22.216.41 66.22.216.42 66.22.216.44/30 66.22.216.50/31 66.22.216.122 66.22.216.124/31 66.22.216.126 66.22.216.128/30 66.22.216.132 66.22.216.139 66.22.216.141 66.22.216.142/31 66.22.216.144 66.22.216.146/31 66.22.216.148/31 66.22.216.150 66.22.216.154/31 66.22.216.156/31 66.22.216.159 66.22.216.178/31 66.22.216.180 66.22.216.182 66.22.216.184 66.22.216.186/31 66.22.216.188/30 66.22.216.193 66.22.216.194/31 66.22.216.200/31 66.22.216.205 66.22.216.206/31 66.22.216.209 66.22.216.210/31 66.22.216.212/31 66.22.217.10/31 66.22.217.13 66.22.217.14/31 66.22.217.16 66.22.217.18/31 66.22.217.20/31 66.22.217.23 66.22.217.24/30 66.22.217.28/31 66.22.217.31 66.22.217.33 66.22.217.34/31 66.22.217.36/30 66.22.217.40/31 66.22.217.43 66.22.217.45 66.22.217.46/31 66.22.217.48/31 66.22.217.51 66.22.217.52/31 66.22.217.54 66.22.217.56/31 66.22.217.108 66.22.217.110/31 66.22.217.112/30 66.22.217.116/31 66.22.217.128 66.22.217.133 66.22.217.134/31 66.22.217.136 66.22.217.145 66.22.217.147 66.22.217.149 66.22.217.150/31 66.22.217.167 66.22.217.168/30 66.22.217.183 66.22.217.184/29 66.22.217.192/30 66.22.217.196 66.22.217.198/31 66.22.217.200/30"
#DISCORD_SUBNETS_BUCHAREST="66.22.244.4/30 66.22.244.8/29 66.22.244.16/28 66.22.244.33 66.22.244.35 66.22.244.36/30 66.22.244.40/30 66.22.244.132/30 66.22.244.136/29 66.22.244.144/31 66.22.244.146 66.22.244.151 66.22.244.152/30 66.22.244.156 66.22.244.158/31 66.22.244.160 66.22.244.170/31"
DISCORD_SUBNETS_FINLAND="35.217.0.79 35.217.0.236 35.217.1.86 35.217.1.111 35.217.1.126 35.217.2.5 35.217.3.104 35.217.3.205 35.217.4.72 35.217.5.33 35.217.5.109 35.217.6.22 35.217.6.59 35.217.6.148 35.217.6.227 35.217.8.35 35.217.8.38 35.217.8.99 35.217.9.8 35.217.9.33 35.217.9.205 35.217.11.186 35.217.12.91 35.217.12.101 35.217.12.133 35.217.12.192 35.217.12.204 35.217.14.209 35.217.14.238 35.217.15.65 35.217.16.75 35.217.17.180 35.217.17.234 35.217.18.14 35.217.18.57 35.217.18.105 35.217.18.142 35.217.19.183 35.217.20.11 35.217.20.32 35.217.20.83 35.217.20.158 35.217.20.178 35.217.20.185 35.217.20.199 35.217.21.143 35.217.21.226 35.217.22.131 35.217.22.170 35.217.22.255 35.217.23.172 35.217.23.193 35.217.24.25 35.217.24.53 35.217.24.139 35.217.24.173 35.217.25.81 35.217.26.127 35.217.26.195 35.217.26.214 35.217.27.170 35.217.27.203 35.217.28.178 35.217.28.218 35.217.29.98 35.217.29.126 35.217.29.174 35.217.29.217 35.217.30.9 35.217.30.49 35.217.30.104 35.217.31.57 35.217.31.96 35.217.32.164 35.217.32.235 35.217.33.19 35.217.33.65 35.217.33.156 35.217.33.158 35.217.33.182 35.217.35.141 35.217.35.208 35.217.36.17 35.217.36.213 35.217.37.16 35.217.37.129 35.217.37.253 35.217.38.179 35.217.39.186 35.217.40.176 35.217.41.204 35.217.43.79 35.217.43.140 35.217.45.248 35.217.46.15 35.217.46.78 35.217.46.140 35.217.47.131 35.217.47.222 35.217.47.254 35.217.48.195 35.217.49.168 35.217.49.182 35.217.50.26 35.217.50.72 35.217.51.20 35.217.51.134 35.217.51.222 35.217.52.117 35.217.53.169 35.217.53.212 35.217.54.5 35.217.54.27 35.217.54.61 35.217.54.66 35.217.54.115 35.217.55.107 35.217.55.117 35.217.56.6 35.217.57.184 35.217.58.122 35.217.58.198 35.217.59.87 35.217.59.122 35.217.60.82 35.217.60.145 35.217.60.234 35.217.61.131 35.217.61.216 35.217.62.48 35.217.62.165 35.217.62.183 35.217.63.144 35.217.63.200"
#DISCORD_SUBNETS_FRANKFURT="35.207.64.4 35.207.64.164 35.207.65.4 35.207.65.231 35.207.67.116 35.207.71.10 35.207.71.24 35.207.71.119 35.207.71.203 35.207.71.218 35.207.72.32 35.207.73.58 35.207.73.154 35.207.74.12 35.207.74.45 35.207.74.109 35.207.74.138 35.207.75.191 35.207.75.219 35.207.76.159 35.207.76.184 35.207.77.67 35.207.77.101 35.207.77.224 35.207.77.238/31 35.207.78.129 35.207.79.34 35.207.79.66 35.207.79.201 35.207.80.76 35.207.81.249 35.207.81.250 35.207.82.54 35.207.82.176 35.207.82.208 35.207.83.118 35.207.83.177 35.207.84.87 35.207.84.205 35.207.85.160 35.207.86.41 35.207.87.184 35.207.89.188 35.207.91.146 35.207.92.230 35.207.95.107 35.207.95.125 35.207.95.255 35.207.97.174 35.207.99.134 35.207.100.74 35.207.100.104 35.207.101.130 35.207.103.70 35.207.103.97 35.207.103.112 35.207.104.10 35.207.104.162 35.207.104.202 35.207.106.153 35.207.106.188 35.207.107.19 35.207.108.198 35.207.108.215 35.207.109.185 35.207.110.73 35.207.110.97 35.207.110.163 35.207.110.175 35.207.110.187 35.207.111.174 35.207.114.16 35.207.115.163 35.207.116.51 35.207.117.24 35.207.117.227 35.207.121.204 35.207.122.37 35.207.122.79 35.207.124.145 35.207.125.116 35.207.126.30 35.207.129.2 35.207.129.199 35.207.131.136 35.207.131.152 35.207.132.247 35.207.135.147 35.207.136.69 35.207.137.4 35.207.137.62 35.207.137.164 35.207.137.207 35.207.139.22 35.207.139.43 35.207.139.154 35.207.139.211 35.207.139.220 35.207.139.227 35.207.140.241 35.207.141.119 35.207.142.63 35.207.142.230 35.207.142.232 35.207.143.96 35.207.143.121 35.207.144.0 35.207.144.109 35.207.145.35 35.207.145.63 35.207.145.203 35.207.146.89 35.207.147.63 35.207.147.121 35.207.147.245 35.207.147.248 35.207.149.52 35.207.149.130 35.207.150.20 35.207.150.137 35.207.150.237 35.207.151.61 35.207.153.117 35.207.154.5 35.207.154.172 35.207.154.200 35.207.154.236 35.207.155.172 35.207.155.216 35.207.156.254 35.207.157.7 35.207.158.192 35.207.160.160 35.207.162.239 35.207.163.49 35.207.163.203 35.207.164.57 35.207.164.73 35.207.164.100 35.207.165.147 35.207.166.36 35.207.166.69 35.207.167.113 35.207.167.122 35.207.167.161 35.207.167.219 35.207.168.116 35.207.170.8 35.207.170.35 35.207.170.135 35.207.170.191 35.207.171.40 35.207.171.99 35.207.171.122 35.207.171.222 35.207.171.225 35.207.172.68 35.207.172.136 35.207.172.246 35.207.174.55 35.207.176.188 35.207.176.206 35.207.176.226 35.207.178.51 35.207.178.228 35.207.180.152 35.207.181.76 35.207.182.125 35.207.184.101 35.207.185.192 35.207.186.188 35.207.186.197 35.207.187.228 35.207.188.57 35.207.188.142 35.207.189.58 35.207.189.98 35.207.190.194 35.207.191.84 35.207.191.113 35.207.191.121 66.22.243.4/30 66.22.243.8/31 66.22.243.10 66.22.243.12/30 66.22.243.16/29 66.22.243.24 66.22.243.27 66.22.243.28/30 66.22.243.32/29 66.22.243.40/30 66.22.243.44/31 66.22.243.46 66.22.243.48/29 66.22.243.56/31 66.22.243.59 66.22.243.61 66.22.243.62 66.22.243.64 66.22.243.132 66.22.243.134/31 66.22.243.137 66.22.243.138/31 66.22.243.141 66.22.243.142/31 66.22.243.144/28 66.22.243.160/29 66.22.243.168/30 66.22.243.172 66.22.243.174/31 66.22.243.176/29 66.22.243.184/31 66.22.243.186 66.22.243.188 66.22.243.190/31"
#DISCORD_SUBNETS_MADRID="34.0.192.36 34.0.192.121 34.0.193.93 34.0.193.212 34.0.194.29 34.0.194.137 34.0.194.191 34.0.194.214 34.0.195.172 34.0.196.200 34.0.196.207 34.0.197.81 34.0.198.25 34.0.199.62 34.0.199.71 34.0.199.158 34.0.200.74 34.0.200.119 34.0.200.173 34.0.200.175 34.0.201.81 34.0.202.34 34.0.203.32 34.0.203.161 34.0.204.37 34.0.204.144 34.0.204.193 34.0.204.195 34.0.205.60 34.0.205.172 34.0.205.207 34.0.205.245 34.0.206.55 34.0.206.71 34.0.207.21 34.0.207.106 34.0.207.111 34.0.207.119 34.0.208.195 34.0.209.55 34.0.209.92 34.0.209.141 34.0.209.159 34.0.209.161 34.0.210.20 34.0.211.21 34.0.211.41 34.0.212.55 34.0.212.174 34.0.213.84 34.0.213.108 34.0.215.129 34.0.215.223 34.0.215.228 34.0.216.238 34.0.217.60 34.0.217.161 34.0.218.83 34.0.220.103 34.0.221.20 34.0.221.227 34.0.222.193 34.0.223.68 66.22.241.5 66.22.241.8 66.22.241.11 66.22.241.12 66.22.241.14/31 66.22.241.16/31 66.22.241.20 66.22.241.23 66.22.241.25 66.22.241.27 66.22.241.33 66.22.241.34/31 66.22.241.36/30 66.22.241.132/30 66.22.241.136 66.22.241.138/31 66.22.241.141 66.22.241.142 66.22.241.146 66.22.241.148/31 66.22.241.152 66.22.241.154 66.22.241.156 66.22.241.158/31 66.22.241.160 66.22.241.162 66.22.241.166"
#DISCORD_SUBNETS_MILAN="35.219.225.149 35.219.226.57 35.219.227.31 35.219.227.163 35.219.228.37 35.219.229.159 35.219.229.187 35.219.229.248 35.219.230.51 35.219.230.140 35.219.230.238 35.219.231.60 35.219.231.131 35.219.231.247 35.219.235.32 35.219.235.52 35.219.235.98 35.219.235.195 35.219.235.248 35.219.236.198 35.219.238.115 35.219.239.85 35.219.239.132 35.219.241.52 35.219.241.142 35.219.241.191 35.219.242.221 35.219.243.191 35.219.244.1 35.219.245.45 35.219.245.56 35.219.245.221 35.219.246.159 35.219.247.14 35.219.247.35 35.219.248.63 35.219.248.230 35.219.249.126 35.219.251.186 35.219.252.64 35.219.252.135 35.219.253.38 35.219.253.218 35.219.254.63 35.219.254.67 35.219.254.197 35.219.254.233 66.22.238.4/30 66.22.238.8/31 66.22.238.10 66.22.238.12 66.22.238.15 66.22.238.16 66.22.238.18/31 66.22.238.21 66.22.238.22/31 66.22.238.24/31 66.22.238.35 66.22.238.36 66.22.238.39 66.22.238.40 66.22.238.132 66.22.238.134/31 66.22.238.136/31 66.22.238.140/30 66.22.238.146/31 66.22.238.149 66.22.238.150/31 66.22.238.152/31 66.22.238.157 66.22.238.158/31 66.22.238.160/31 66.22.238.162"
#DISCORD_SUBNETS_ROTTERDAM="35.214.128.248 35.214.129.220 35.214.130.217 35.214.131.144 35.214.132.189 35.214.133.102 35.214.133.180 35.214.134.163 35.214.137.47 35.214.137.136 35.214.138.48 35.214.138.95 35.214.138.117 35.214.140.97 35.214.140.183 35.214.140.185 35.214.142.123 35.214.142.233 35.214.143.41 35.214.144.26 35.214.145.200 35.214.146.9 35.214.147.135 35.214.148.89 35.214.149.110 35.214.151.181 35.214.151.193 35.214.152.46 35.214.152.158 35.214.152.244 35.214.156.115 35.214.158.181 35.214.159.158 35.214.159.172 35.214.159.205 35.214.160.137 35.214.160.198 35.214.161.217 35.214.162.72 35.214.162.126 35.214.162.183 35.214.163.28 35.214.165.102 35.214.167.77 35.214.169.86 35.214.169.198 35.214.170.2 35.214.171.28 35.214.171.75 35.214.171.117 35.214.172.138 35.214.172.251 35.214.173.102 35.214.173.225 35.214.175.38 35.214.175.180 35.214.177.183 35.214.179.46 35.214.180.75 35.214.180.218 35.214.180.229 35.214.181.64 35.214.181.71 35.214.181.166 35.214.181.207 35.214.181.209 35.214.184.179 35.214.185.28 35.214.186.3 35.214.187.30 35.214.187.54 35.214.187.151 35.214.187.212 35.214.191.31 35.214.191.35 35.214.191.224 35.214.192.135 35.214.192.253 35.214.193.95 35.214.193.140 35.214.194.190 35.214.194.214 35.214.195.15 35.214.195.71 35.214.196.89 35.214.196.107 35.214.197.71 35.214.197.107 35.214.197.168 35.214.198.7 35.214.199.224 35.214.201.59 35.214.201.74 35.214.203.155 35.214.204.113 35.214.204.174 35.214.204.252 35.214.205.33 35.214.205.145 35.214.207.84 35.214.207.131 35.214.208.159 35.214.208.163 35.214.208.250 35.214.208.253 35.214.209.64 35.214.210.2 35.214.210.194 35.214.211.3 35.214.212.66 35.214.212.79 35.214.212.124 35.214.213.22 35.214.213.113 35.214.214.83 35.214.214.242 35.214.215.89 35.214.215.121 35.214.216.72 35.214.216.77 35.214.216.150 35.214.217.3 35.214.217.90 35.214.217.239 35.214.218.140 35.214.219.50 35.214.219.181 35.214.220.149 35.214.221.107 35.214.221.167 35.214.222.149 35.214.223.117 35.214.223.155 35.214.224.71 35.214.225.26 35.214.225.36 35.214.225.156 35.214.226.96 35.214.226.104 35.214.226.222 35.214.227.39 35.214.227.157 35.214.228.116 35.214.228.178 35.214.228.211 35.214.229.12 35.214.229.53 35.214.229.73 35.214.229.162 35.214.231.187 35.214.233.8 35.214.235.38 35.214.237.105 35.214.237.122 35.214.237.216 35.214.238.32 35.214.238.59 35.214.238.121 35.214.239.77 35.214.239.161 35.214.240.87 35.214.241.18 35.214.241.107 35.214.241.224 35.214.243.21 35.214.244.45 35.214.244.113 35.214.244.123 35.214.244.177 35.214.245.20 35.214.245.24 35.214.246.106 35.214.248.119 35.214.249.154 35.214.250.20 35.214.250.53 35.214.250.201 35.214.251.129 35.214.251.200 35.214.252.187 35.214.253.49 35.214.253.172 35.214.255.154 66.22.196.4 66.22.196.6/31 66.22.196.8/29 66.22.196.16/28 66.22.196.32/28 66.22.196.48/30 66.22.197.40 66.22.197.42 66.22.197.45 66.22.197.46/31 66.22.197.48/31 66.22.197.53 66.22.197.54/31 66.22.197.59 66.22.197.78/31 66.22.197.80/31 66.22.197.82 66.22.197.85 66.22.197.86/31 66.22.197.88/31 66.22.197.91 66.22.197.92/30 66.22.197.96/30 66.22.197.131 66.22.197.132/31 66.22.197.134 66.22.197.136/31 66.22.197.138 66.22.197.140/31 66.22.198.4/30 66.22.198.8/29 66.22.198.16/29 66.22.198.24/30 66.22.198.28/31 66.22.198.30 66.22.198.34/31 66.22.198.36/31 66.22.198.39 66.22.198.40/29 66.22.198.48 66.22.198.50/31 66.22.198.54/31 66.22.199.22/31 66.22.199.27 66.22.199.33 66.22.199.34/31 66.22.199.37 66.22.199.40 66.22.199.42 66.22.199.45 66.22.199.46 66.22.199.48 66.22.199.55 66.22.199.77 66.22.199.81 66.22.199.82/31 66.22.199.84/30 66.22.199.89 66.22.199.90/31 66.22.199.92/30 66.22.199.96/29 66.22.199.104/31 66.22.199.107 66.22.199.138"
DISCORD_SUBNETS_STOCKHOLM="66.22.237.4/30 66.22.237.8/29 66.22.237.16/29 66.22.237.24/30 66.22.237.36/30 66.22.237.40/30 66.22.237.44/31 66.22.237.132/30 66.22.237.136/29 66.22.237.144/28 66.22.237.160/30 66.22.237.164/31"
DISCORD_SUBNETS_WARSAW="34.0.240.1 34.0.240.34 34.0.240.39 34.0.240.53 34.0.240.72 34.0.240.84 34.0.240.94 34.0.240.96 34.0.240.99 34.0.240.100 34.0.240.121 34.0.240.175 34.0.240.204 34.0.240.207 34.0.240.237 34.0.240.240 34.0.240.245 34.0.240.254 34.0.241.8 34.0.241.14 34.0.241.51 34.0.241.71 34.0.241.112 34.0.241.144 34.0.241.149 34.0.241.150 34.0.241.162 34.0.241.180 34.0.241.194 34.0.241.220 34.0.241.223 34.0.242.7 34.0.242.39 34.0.242.42 34.0.242.46 34.0.242.95 34.0.242.134 34.0.242.158 34.0.242.166 34.0.242.180 34.0.242.195 34.0.242.233 34.0.243.14 34.0.243.20 34.0.243.25 34.0.243.60 34.0.243.199 34.0.243.218 34.0.243.231 34.0.244.15 34.0.244.45 34.0.244.48 34.0.244.75 34.0.244.83 34.0.244.98 34.0.244.112 34.0.244.121 34.0.244.142 34.0.244.145 34.0.244.165 34.0.244.196 34.0.244.201 34.0.244.207 34.0.244.230 34.0.244.243 34.0.245.18 34.0.245.54 34.0.245.62 34.0.245.73 34.0.245.81 34.0.245.95 34.0.245.96 34.0.245.158 34.0.245.173 34.0.245.193 34.0.245.199 34.0.245.220 34.0.245.234 34.0.246.15 34.0.246.39 34.0.246.59 34.0.246.63 34.0.246.66 34.0.246.70 34.0.246.119 34.0.246.148 34.0.246.174 34.0.246.185 34.0.246.214/31 34.0.246.222 34.0.246.240 34.0.246.242 34.0.246.245 34.0.247.11 34.0.247.19 34.0.247.21 34.0.247.26 34.0.247.39 34.0.247.85 34.0.247.100 34.0.247.118 34.0.247.120 34.0.247.154 34.0.247.190 34.0.247.217 34.0.247.218 34.0.247.227 34.0.247.249 34.0.248.19 34.0.248.21 34.0.248.34 34.0.248.48 34.0.248.61 34.0.248.104 34.0.248.141 34.0.248.148 34.0.248.182 34.0.248.205 34.0.248.218 34.0.248.221 34.0.248.228 34.0.249.7 34.0.249.68 34.0.249.71 34.0.249.101 34.0.249.104 34.0.249.116 34.0.249.148 34.0.249.154 34.0.249.158 34.0.249.187 34.0.249.203 34.0.249.220 34.0.249.228 34.0.249.234 34.0.249.237 34.0.249.238 34.0.249.245 34.0.249.254 34.0.250.10 34.0.250.34 34.0.250.38 34.0.250.46 34.0.250.56 34.0.250.71 34.0.250.73 34.0.250.77 34.0.250.90 34.0.250.133 34.0.250.135 34.0.250.144 34.0.250.156 34.0.250.179 34.0.250.187 34.0.250.189 34.0.250.203 34.0.251.17 34.0.251.86"
SUBNETS="${DISCORD_SUBNETS_RUSSIA:-} ${DISCORD_SUBNETS_BUCHAREST:-} ${DISCORD_SUBNETS_FINLAND:-} ${DISCORD_SUBNETS_FRANKFURT:-} ${DISCORD_SUBNETS_MADRID:-} ${DISCORD_SUBNETS_MILAN:-} ${DISCORD_SUBNETS_ROTTERDAM:-} ${DISCORD_SUBNETS_STOCKHOLM:-} ${DISCORD_SUBNETS_WARSAW:-}"
# IPs resolved from domains listed at: https://github.com/GhostRooter0953/discord-voice-ips/blob/master/voice_domains/discord-voice-domains-list

SET_NAME=discord

zapret_custom_firewall() {
  local f
  local first_packets_only="$ipt_connbytes 1:3"
  local PORTS_IPT=$(replace_char - : "$NFQWS_PORTS_UDP_DISCORD")
  local dest_set="-m set --match-set $SET_NAME dst"
  local subnet

  local DISABLE_IPV6=1

  [ "$1" = 1 ] && {
    ipset create $SET_NAME hash:net hashsize 2048 maxelem 4096 2>/dev/null
    ipset flush $SET_NAME
    for subnet in $SUBNETS; do
      echo add $SET_NAME "$subnet"
    done | ipset -! restore
  }

  f="-p udp -m multiport --dports $PORTS_IPT"
  fw_nfqws_post "$1" "$f $first_packets_only $dest_set" "$f $first_packets_only $dest_set" 200

  [ "$1" = 1 ] || ipset destroy $SET_NAME 2>/dev/null
}

zapret_custom_firewall_nft() {
  local f
  local first_packets_only="$nft_connbytes 1-3"
  local dest_set="ip daddr @$SET_NAME"
  local subnets

  local DISABLE_IPV6=1

  make_comma_list subnets "$SUBNETS"
  nft_create_set $SET_NAME "type ipv4_addr; size 4096; auto-merge; flags interval;"
  nft_flush_set $SET_NAME
  nft_add_set_element $SET_NAME "$subnets"

  f="udp dport {$NFQWS_PORTS_UDP_DISCORD}"
  nft_fw_nfqws_post "$f $first_packets_only $dest_set" "$f $first_packets_only $dest_set" 200
}

zapret_custom_firewall_nft_flush() {
	# this function is called after all nft fw rules are deleted
	# however sets are not deleted. it's desired to clear sets here.
  nft_del_set $SET_NAME 2>/dev/null
}
